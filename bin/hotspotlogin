#!/usr/bin/env ruby

require 'rubygems'
require 'sinatra/base'

if File.symlink? __FILE__
  file = File.readlink __FILE__
else
  file = __FILE__
end

require File.expand_path(
  File.dirname(file) + "/../lib/hotspotlogin"
)

config = HotSpotLogin.config

app_blk = proc{|server| } # nothing/blank

if 
    config['ssl'] != false                                    and
      # nil means unspecified, false means explicitely 
      # disabled, tipically from command line
    config['ssl-cert']  and File.readable? config['ssl-cert'] and
    config['ssl-key']   and File.readable? config['ssl-key']

  # Inspired by 
  # http://stackoverflow.com/questions/11405161/enable-ssl-in-sinatra-with-thin/15511536#15511536
  app_blk = proc do |server|
    ssl_options = {
      :cert_chain_file  => config['ssl-cert'],
      :private_key_file => config['ssl-key'],
      :verify_peer      => false
    }
    server.ssl = true
    server.ssl_options = ssl_options
  end
end

if config['daemon']
  pid = fork do
    Process.setsid
    if config['log'] 
      STDOUT.reopen(config['log'], 'a')
      STDERR.reopen(config['log'], 'a') 
      Signal.trap('USR1') do
        STDOUT.flush
        STDERR.flush
      end
    end
    HotSpotLogin::App.run! &app_blk
 
    FileUtils.rm config['pid'] if config['pid'] and File.exists? config['pid']
  end
  if config['pid'] =~ /\S/ 
    File.open config['pid'], 'w' do |f|
      f.write pid 
    end
  end
  Process.detach pid
else # run in foreground
  HotSpotLogin::App.run! &app_blk
end
